#include "stdint.h"
#include "HardwareSerial.h"
#define I2C_SLAVE_ADDR 0x04

static int Image_Buffer[32][32] = {//32*32の配列にRGBデータを保存するもの

    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},


 };

 ////////////camera_serilaの変数/////////

      camera_fb_t * fb = NULL;
      esp_err_t res = ESP_OK;

      uint8_t * test_buf = NULL;
      uint8_t red = 0, green = 0, blue = 0;
      const uint16_t max_h_pix = 160 * 3;
      const uint16_t max_v_pix = 120;
      int rgb_16_line;
      int counter;

    
  


    ///////////////////////////////////////

    ////////////wire_cameraの変数/////////

    unsigned long lastWireTransmit = 0;
    byte x = 0;
  
  

    ///////////////////////////////////////


void camera_serial(){

  WirePacker packer;


  fb = esp_camera_fb_get();
  if (!fb) {
    Serial.println("Camera capture failed");
    return;
  }
 //////////////カメラからRGB値を取得する///////////////////////

  test_buf = fb->buf;
  
///////////////////////////////////////////////////////////////


///////////////////32*32のピクセルに変換/////////////////////////

  for(int j = 0; j < 32; j++){//縦
    for(int i = 0; i < 32; i++){//横
      WirePacker packer;
      red = *(test_buf + j * max_h_pix + i);
      green = *(test_buf + j * max_h_pix + (i+1));
      blue = *(test_buf + j * max_h_pix + (i+2));


/////////////各RGB値を文字列に変換////////////////////////

      String r = String(red);
      String g = String(green);
      String b = String(blue);
      String rgb = "{" + r + "," + g + "," + b + "}";
      String rgb_16 = r+g+b;

      /*Serial.print("rgb = ");
      Serial.println(rgb);

      Serial.print("rgb_16 = ");
      Serial.println(rgb_16);

      Serial.print("rgb_16_line = ");
      Serial.println(rgb_16_line);*/

      int rgb_16_line = rgb_16.toInt();
   
/////////////////////それぞれのRGB値をスレーブに送信/////////////////////

      packer.write(r.toInt());
      packer.write(g.toInt());
      packer.write(b.toInt());
     

/////////////////////int型配列の32*32に入れる/////////////////

      Image_Buffer[j][i] = rgb_16_line;
      Serial.print("Image_Buffer[");
      Serial.print(j);
      Serial.print("][");
      Serial.print(i);
      Serial.print("]=");
      Serial.println(Image_Buffer[j][i]);
      //packer.write(rgb_16_line);//データを送る量は3桁まで。それ以上長くなると数値がおかしくなる。

      

      



      packer.end();
        // now transmit the packed data
        Wire.beginTransmission(I2C_SLAVE_ADDR);
        while (packer.available()) {    // write every packet byte
            Wire.write(packer.read());
        }
        Wire.endTransmission();      // stop transmitting*/

   
  }
  //Serial.println();
  }
  Serial.println("------------------------------------------------------------");
 
  delay(1000);
 }

 

 